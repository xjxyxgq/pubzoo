# 数据库状态检查功能

## 功能描述
在操作目标数据库前，程序会自动检查数据库状态，确保数据库可以安全地执行写操作。

## 检查项目

### 1. 只读状态检查
- **检查命令**: `SELECT @@read_only`
- **检查标准**: 值必须为 0（非只读状态）
- **失败情况**: 如果值为 1，表示数据库处于只读状态，无法执行删除操作

### 2. 从节点检查
- **检查命令**: `SHOW SLAVE STATUS`
- **检查标准**: 不能有主从复制配置
- **失败情况**: 如果有复制配置记录，表示是从节点，无法执行删除操作

## 检查时机

### 查询阶段
在统计数据行数前检查数据库状态：
```
1. 连接目标数据库
2. 检查数据库状态 ← 新增
3. 获取归档列数据类型
4. 统计符合条件的行数
```

### 删除阶段
在执行删除操作前再次检查数据库状态：
```
1. 连接目标数据库
2. 再次检查数据库状态 ← 新增
3. 获取列数据类型
4. 备份数据
5. 删除数据
```

## 错误示例

### 只读状态错误
```
❌ 任务处理失败: 数据库状态检查失败: 数据库 localhost:3306/test_db 处于只读状态，无法执行写操作
```

### 从节点错误
```
❌ 任务处理失败: 数据库状态检查失败: 数据库 localhost:3306/test_db 是从节点，无法执行写操作
```

## 正常输出示例

```
--- 处理任务 1/3 ---
目标: localhost:3306/test_db.user_logs, 条件: 20240101, 预期行数: 1000
找到归档列: created_at
检查数据库状态...
✓ 数据库状态正常，可以执行写操作
归档列数据类型: datetime
实际行数: 1200
预期行数: 1000
⚠️  行数不匹配，差异: 200

数据行数不匹配，是否删除目标数据？
表: test_db.user_logs
条件: 20240101
将删除 1200 行数据
请输入 y/yes 确认删除，或 n/no 跳过: y

再次检查数据库状态...
✓ 删除前数据库状态正常
正在备份数据...
✓ 数据已备份到: ./backups/backup_test_db_user_logs_20240630_160530.sql
正在删除数据...
✓ 成功删除 1200 行数据
```

## 安全保障

1. **双重检查**: 查询阶段和删除阶段都会检查数据库状态
2. **实时检查**: 每次操作前都会重新检查，防止状态在操作过程中发生变化
3. **明确提示**: 清楚地显示检查结果和错误原因
4. **操作中断**: 一旦发现数据库状态不合适，立即中断操作

## 技术实现

```go
// 检查数据库状态
func (dm *DatabaseManager) CheckDatabaseStatus(db *sql.DB, host, database string) error {
    // 1. 检查只读状态
    var readOnly int
    err := db.QueryRow("SELECT @@read_only").Scan(&readOnly)
    if readOnly == 1 {
        return fmt.Errorf("数据库处于只读状态")
    }
    
    // 2. 检查从节点状态
    isSlaveNode, err := dm.checkSlaveStatus(db)
    if isSlaveNode {
        return fmt.Errorf("数据库是从节点")
    }
    
    return nil
}
```

这样可以确保程序只在安全的数据库环境中执行删除操作，避免意外操作只读数据库或从节点。 